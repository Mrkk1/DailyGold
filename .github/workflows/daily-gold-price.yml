name: ğŸ“ˆ æ¯æ—¥é‡‘ä»·è·å–

on:
  schedule:
    # æ¯å¤©å¤šæ¬¡æ‰§è¡Œï¼Œç¡®ä¿GitHubè´¡çŒ®å›¾ä¿æŒæ´»è·ƒ
    - cron: '0 1 * * *'   # åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹ (UTC 1:00)
    - cron: '0 6 * * *'   # åŒ—äº¬æ—¶é—´ä¸‹åˆ2ç‚¹ (UTC 6:00)  
    - cron: '0 10 * * *'  # åŒ—äº¬æ—¶é—´ä¸‹åˆ6ç‚¹ (UTC 10:00)
    - cron: '0 14 * * *'  # åŒ—äº¬æ—¶é—´æ™šä¸Š10ç‚¹ (UTC 14:00)
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]

jobs:
  fetch-gold-price:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: ğŸš€ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas python-dateutil
    
    - name: ğŸ† è·å–é‡‘ä»·æ•°æ®
      run: |
        python fetch_gold_price.py
    
    - name: ğŸ“Š ç”Ÿæˆæ•°æ®æŠ¥å‘Š
      run: |
        echo "## ğŸ“ˆ ä»Šæ—¥é‡‘ä»·æŠ¥å‘Š" > daily_report.md
        echo "" >> daily_report.md
        echo "**è·å–æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> daily_report.md
        echo "" >> daily_report.md
        if [ -f "data/gold_prices.json" ]; then
          echo "**æ•°æ®æ–‡ä»¶**: âœ… å·²ç”Ÿæˆ" >> daily_report.md
          echo "**æ–‡ä»¶å¤§å°**: $(du -h data/gold_prices.json | cut -f1)" >> daily_report.md
        else
          echo "**æ•°æ®æ–‡ä»¶**: âŒ ç”Ÿæˆå¤±è´¥" >> daily_report.md
        fi
        echo "" >> daily_report.md
        echo "---" >> daily_report.md
        echo "*æ­¤æŠ¥å‘Šç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*" >> daily_report.md
    
    - name: ğŸ”§ é…ç½®Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: ğŸ’¾ æäº¤æ•°æ®æ›´æ–°
      run: |
        git add .
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ•°æ®å˜æ›´ï¼Œè·³è¿‡æäº¤"
        else
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          
          # è·å–æœ€æ–°é‡‘ä»·ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
          LATEST_PRICE="è·å–ä¸­..."
          
          # æäº¤å˜æ›´
          git commit -m "ğŸ“ˆ æ›´æ–°æ¯æ—¥é‡‘ä»·æ•°æ® - $CURRENT_TIME | ğŸ† æœ€æ–°é‡‘ä»·: $LATEST_PRICE/oz | ğŸ¤– è‡ªåŠ¨æäº¤ #DailyGold #AutoCommit #KeepGreen"
          
          git push
          
          echo "âœ… æ•°æ®å·²æˆåŠŸæäº¤åˆ°ä»“åº“"
        fi
    
    - name: ğŸ“ˆ ç”Ÿæˆè´¡çŒ®ç»Ÿè®¡
      run: |
        echo "ğŸ‰ GitHubè´¡çŒ®å›¾ä¿æŒæ´»è·ƒï¼"
        echo "ğŸ“Š ä»Šæ—¥ä»»åŠ¡å®Œæˆæƒ…å†µï¼š"
        echo "  âœ… é‡‘ä»·æ•°æ®è·å–"
        echo "  âœ… æ•°æ®æ–‡ä»¶æ›´æ–°" 
        echo "  âœ… è‡ªåŠ¨æäº¤æ¨é€"
        echo "  âœ… è´¡çŒ®å›¾ä¿æŒç»¿è‰²"
